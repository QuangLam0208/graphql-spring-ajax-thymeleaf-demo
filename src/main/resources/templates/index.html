<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>GraphQL Shop Demo</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1, h2 { color: #2c3e50; text-align: center; }
        
        /* Button Style */
        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; transition: 0.3s; color: white; text-decoration: none; display: inline-block;}
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-success { background-color: #2ecc71; }
        .btn-success:hover { background-color: #27ae60; }
        .btn-tool { background-color: #e74c3c; float: right; } /* N√∫t sang GraphiQL */
        .btn-tool:hover { background-color: #c0392b; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #34495e; color: white; }
        tr:hover { background-color: #f1f1f1; }

        /* Form Style */
        .form-group { margin-bottom: 15px; display: flex; gap: 10px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex: 1; }
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-actions">
            <h1>üõçÔ∏è Qu·∫£n L√Ω S·∫£n Ph·∫©m</h1>
            <a href="/graphiql" target="_blank" class="btn btn-tool">üöÄ M·ªü GraphiQL Tool</a>
        </div>

        <hr>

        <h3>‚ûï Th√™m s·∫£n ph·∫©m m·ªõi (Mutation Demo)</h3>
        <div class="form-group">
            <input type="text" id="newTitle" placeholder="T√™n s·∫£n ph·∫©m (VD: iPhone 16)" />
            <input type="number" id="newPrice" placeholder="Gi√° (VD: 20000000)" />
            <input type="number" id="catId" placeholder="ID Danh m·ª•c (VD: 1)" style="max-width: 150px;"/>
            <button class="btn btn-success" onclick="createProduct()">L∆∞u Ngay</button>
        </div>

        <hr>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>üìã Danh s√°ch s·∫£n ph·∫©m (Gi√° tƒÉng d·∫ßn)</h3>
            <button class="btn btn-primary" onclick="loadProducts()">üîÑ T·∫£i D·ªØ Li·ªáu</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th>T√™n SP</th>
                    <th>Gi√°</th>
                    <th>Danh m·ª•c</th>
                </tr>
            </thead>
            <tbody id="productTable">
                <tr><td colspan="4" style="text-align:center;">Vui l√≤ng b·∫•m n√∫t t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // 1. H√†m Load danh s√°ch (Query)
        async function loadProducts() {
            const query = `
                query {
                    productsSortedByPrice {
                        id
                        title
                        price
                        category { name }
                    }
                }
            `;
            await fetchGraphQL(query, (data) => {
                const products = data.productsSortedByPrice;
                let html = '';
                products.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.id}</td>
                            <td>${p.title}</td>
                            <td>${p.price.toLocaleString()} ƒë</td>
                            <td>${p.category ? p.category.name : '<span style="color:gray">Ch∆∞a c√≥</span>'}</td>
                        </tr>
                    `;
                });
                document.getElementById('productTable').innerHTML = html;
            });
        }

        // 2. H√†m Th√™m m·ªõi (Mutation)
        async function createProduct() {
            const title = document.getElementById('newTitle').value;
            const price = parseFloat(document.getElementById('newPrice').value);
            const catId = parseInt(document.getElementById('catId').value);

            if(!title || !price) { alert("Vui l√≤ng nh·∫≠p t√™n v√† gi√°!"); return; }

            // C·∫•u tr√∫c Mutation g·ªçi API
            const mutation = `
                mutation {
                    createProduct(product: {
                        title: "${title}",
                        price: ${price},
                        quantity: 1,
                        desc: "M√¥ t·∫£ m·∫´u t·ª´ Web",
                        userId: 1,
                        categoryId: ${catId || 1}
                    }) {
                        id
                        title
                    }
                }
            `;

            await fetchGraphQL(mutation, (data) => {
                alert("‚úÖ ƒê√£ th√™m th√†nh c√¥ng s·∫£n ph·∫©m: " + data.createProduct.title);
                loadProducts(); // T·∫£i l·∫°i danh s√°ch ngay sau khi th√™m
                document.getElementById('newTitle').value = "";
                document.getElementById('newPrice').value = "";
            });
        }

        // H√†m g·ªçi API chung ƒë·ªÉ ƒë·ª° vi·∫øt l·∫°i code fetch
        async function fetchGraphQL(queryStr, callback) {
            try {
                const response = await fetch('/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: queryStr })
                });
                const result = await response.json();
                if (result.errors) {
                    console.error(result.errors);
                    alert("L·ªói GraphQL: " + result.errors[0].message);
                } else {
                    callback(result.data);
                }
            } catch (error) {
                console.error('L·ªói m·∫°ng:', error);
                alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!");
            }
        }
    </script>
</body>
</html>